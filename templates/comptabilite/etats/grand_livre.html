{% extends 'comptabilite/base_compta.html' %}
{% load compta_tags %}

{% block title %}Grand Livre{% endblock %}

{% block compta_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4><i class="bi bi-file-earmark-text me-2"></i>Grand Livre</h4>
    <button onclick="window.print()" class="btn btn-outline-secondary"><i class="bi bi-printer me-1"></i>Imprimer</button>
</div>

<!-- En-tête entreprise -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body text-center py-3" style="background: linear-gradient(90deg, #EF7707 0%, #FF8C00 100%); color: white; border-radius: 12px;">
        <h5 class="mb-1">{{ request.user.entreprise.nom_entreprise }}</h5>
        <p class="mb-0">GRAND LIVRE COMPTABLE</p>
        <small>Du {{ date_debut|date:"d/m/Y"|default:"--/--/----" }} au {{ date_fin|date:"d/m/Y"|default:"--/--/----" }}</small>
    </div>
</div>

<!-- Filtres -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label small">Compte</label>
                <select name="compte" class="form-select">
                    <option value="">Tous les comptes</option>
                    {% for c in comptes %}<option value="{{ c.pk }}" {% if compte_id == c.pk|stringformat:"s" %}selected{% endif %}>{{ c.numero_compte }} - {{ c.intitule|truncatechars:30 }}</option>{% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Date début</label>
                <input type="date" name="date_debut" class="form-control" value="{{ date_debut|date:'Y-m-d'|default:'' }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small">Date fin</label>
                <input type="date" name="date_fin" class="form-control" value="{{ date_fin|date:'Y-m-d'|default:'' }}">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search me-1"></i>Filtrer</button>
            </div>
        </form>
    </div>
</div>

<!-- Grand Livre par compte -->
{% regroup lignes by compte as comptes_group %}
{% for compte_lignes in comptes_group %}
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header" style="background-color: #FFD699;">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <strong>{{ compte_lignes.grouper.numero_compte }}</strong> - {{ compte_lignes.grouper.intitule }}
            </h6>
            <span class="badge bg-secondary">{{ compte_lignes.list|length }} mouvement(s)</span>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 10%">Date</th>
                        <th style="width: 8%">Journal</th>
                        <th style="width: 12%">N° Pièce</th>
                        <th style="width: 40%">Libellé</th>
                        <th style="width: 15%" class="text-end">Débit</th>
                        <th style="width: 15%" class="text-end">Crédit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for l in compte_lignes.list %}
                    <tr>
                        <td>{{ l.ecriture.date_ecriture|date:"d/m/Y" }}</td>
                        <td><span class="badge bg-secondary">{{ l.ecriture.journal.code }}</span></td>
                        <td>{{ l.ecriture.numero_ecriture }}</td>
                        <td>{{ l.libelle|default:l.ecriture.libelle }}</td>
                        <td class="text-end">{% if l.montant_debit %}{{ l.montant_debit|floatformat:0 }}{% endif %}</td>
                        <td class="text-end">{% if l.montant_credit %}{{ l.montant_credit|floatformat:0 }}{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light fw-bold">
                    {% with compte_totaux=totaux_par_compte|get_item:compte_lignes.grouper.numero_compte %}
                    <tr>
                        <td colspan="4" class="text-end">Total compte {{ compte_lignes.grouper.numero_compte }} :</td>
                        <td class="text-end text-primary">
                            {% if compte_totaux.debit %}{{ compte_totaux.debit|floatformat:0 }}{% endif %}
                        </td>
                        <td class="text-end text-success">
                            {% if compte_totaux.credit %}{{ compte_totaux.credit|floatformat:0 }}{% endif %}
                        </td>
                    </tr>
                    {% endwith %}
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% empty %}
<div class="card border-0 shadow-sm">
    <div class="card-body text-center py-5 text-muted">
        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
        Aucune écriture validée pour les critères sélectionnés
    </div>
</div>
{% endfor %}

<div class="mt-3 text-muted small text-center">
    <i class="bi bi-info-circle me-1"></i> Seules les écritures validées sont affichées dans le grand livre
</div>
{% endblock %}
