{% extends "comptabilite/base_compta.html" %}
{% load i18n %}

{% block title %}Document {{ document.reference }}{% endblock %}

{% block compta_content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h1 class="h3 mb-1"><i class="bi bi-file-earmark me-2"></i>{{ document.reference }}</h1>
            <p class="text-muted mb-0">{{ document.titre }}</p>
        </div>
        <div class="btn-group">
            <a href="{% url 'comptabilite:archivage_document_update' document.pk %}" class="btn btn-primary"><i class="bi bi-pencil me-1"></i>Modifier</a>
            <a href="{% url 'comptabilite:archivage_documents' %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-1"></i>Retour</a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header"><h5 class="card-title mb-0">Informations générales</h5></div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr><th class="text-muted" width="40%">Classement</th><td>{{ document.classement.libelle|default:"-" }}</td></tr>
                                <tr><th class="text-muted">Politique</th><td>{{ document.politique_retention|default:"-" }}</td></tr>
                                <tr><th class="text-muted">Format</th><td><span class="badge bg-secondary">{{ document.get_format_fichier_display }}</span></td></tr>
                                <tr><th class="text-muted">Taille</th><td>{{ document.taille_octets|filesizeformat }}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr><th class="text-muted" width="40%">Date document</th><td>{{ document.date_document|date:"d/m/Y" }}</td></tr>
                                <tr><th class="text-muted">Exercice</th><td>{{ document.exercice|default:"-" }}</td></tr>
                                <tr><th class="text-muted">Expiration</th><td>{{ document.date_expiration|date:"d/m/Y"|default:"-" }}</td></tr>
                                <tr><th class="text-muted">Confidentialité</th><td><span class="badge bg-info">{{ document.get_niveau_confidentialite_display }}</span></td></tr>
                            </table>
                        </div>
                    </div>
                    {% if document.description %}
                    <hr>
                    <h6>Description</h6>
                    <p>{{ document.description }}</p>
                    {% endif %}
                </div>
            </div>

            {% if document.fichier %}
            <div class="card mb-4">
                <div class="card-header"><h5 class="card-title mb-0">Fichier</h5></div>
                <div class="card-body text-center">
                    <a href="{{ document.fichier.url }}" class="btn btn-primary" target="_blank"><i class="bi bi-download me-1"></i>Télécharger</a>
                </div>
            </div>
            {% endif %}

            {% if traces %}
            <div class="card">
                <div class="card-header"><h5 class="card-title mb-0">Historique des accès</h5></div>
                <div class="card-body p-0">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr><th>Date</th><th>Type</th><th>Utilisateur</th><th>Résultat</th></tr>
                        </thead>
                        <tbody>
                            {% for trace in traces %}
                            <tr>
                                <td>{{ trace.date_acces|date:"d/m/Y H:i" }}</td>
                                <td>{{ trace.get_type_acces_display }}</td>
                                <td>{{ trace.utilisateur|default:"-" }}</td>
                                <td>{% if trace.succes %}<span class="badge bg-success">OK</span>{% else %}<span class="badge bg-danger">Échec</span>{% endif %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header"><h5 class="card-title mb-0">Statut</h5></div>
                <div class="card-body text-center">
                    {% if document.statut == 'actif' %}
                    <span class="badge bg-success fs-5">Actif</span>
                    {% elif document.statut == 'archive' %}
                    <span class="badge bg-info fs-5">Archivé</span>
                    {% elif document.statut == 'a_detruire' %}
                    <span class="badge bg-warning text-dark fs-5">À détruire</span>
                    {% else %}
                    <span class="badge bg-dark fs-5">Détruit</span>
                    {% endif %}
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header"><h5 class="card-title mb-0">Audit</h5></div>
                <div class="card-body">
                    <small class="text-muted">
                        <p class="mb-1"><strong>Archivé le:</strong> {{ document.date_archivage|date:"d/m/Y H:i" }}</p>
                        <p class="mb-0"><strong>Par:</strong> {{ document.archive_par|default:"-" }}</p>
                    </small>
                </div>
            </div>

            {% if validations %}
            <div class="card">
                <div class="card-header"><h5 class="card-title mb-0">Validations</h5></div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for v in validations %}
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Niveau {{ v.niveau_validation }}</span>
                            {% if v.statut == 'valide' %}
                            <span class="badge bg-success">Validé</span>
                            {% elif v.statut == 'rejete' %}
                            <span class="badge bg-danger">Rejeté</span>
                            {% else %}
                            <span class="badge bg-warning text-dark">En attente</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
