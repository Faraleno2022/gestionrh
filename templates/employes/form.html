{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}
{% if object %}Modifier employé{% else %}Nouvel employé{% endif %} - Gestionnaire RH Guinée
{% endblock %}

{% block extra_css %}
<style>
    .nav-tabs .nav-link {
        color: #495057;
    }
    .nav-tabs .nav-link.active {
        color: #EF7707;
        font-weight: 600;
    }
    .tab-content {
        padding: 20px;
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 5px 5px;
    }
    .required-field::after {
        content: " *";
        color: red;
    }
    /* Styles pour la capture caméra */
    #camera-container {
        display: none;
        margin-top: 10px;
    }
    #camera-preview {
        width: 100%;
        max-width: 320px;
        border-radius: 8px;
        border: 2px solid #dee2e6;
    }
    #camera-canvas {
        display: none;
    }
    .camera-controls {
        margin-top: 10px;
    }
    .photo-preview-container {
        margin-top: 10px;
    }
    .photo-preview-container img {
        max-width: 200px;
        border-radius: 8px;
        border: 2px solid #EF7707;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-person-{% if object %}gear{% else %}plus{% endif %}"></i>
        {% if object %}
            Modifier l'employé : {{ object.nom }} {{ object.prenoms }}
        {% else %}
            Nouvel employé
        {% endif %}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'employes:list' %}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Retour à la liste
        </a>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header text-white" style="background: linear-gradient(135deg, #EF7707 0%, #FF8C00 100%);">
                <h5 class="mb-0">
                    <i class="bi bi-file-earmark-person"></i> 
                    Informations de l'employé
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Information :</strong> Les champs marqués d'un astérisque (<span class="text-danger">*</span>) sont obligatoires.
                    Le matricule sera généré automatiquement si vous le laissez vide.
                </div>

                {% crispy form %}
            </div>
        </div>
    </div>
</div>

<!-- Section Famille -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header text-white" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                <h5 class="mb-0">
                    <i class="bi bi-people-fill"></i> 
                    Informations familiales (optionnel)
                </h5>
            </div>
            <div class="card-body">
                <!-- Conjoint -->
                <h5 class="mb-3"><i class="bi bi-heart"></i> Conjoint(e)</h5>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Nom du conjoint</label>
                        <input type="text" name="conjoint_nom" class="form-control" placeholder="Nom">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Prénoms du conjoint</label>
                        <input type="text" name="conjoint_prenoms" class="form-control" placeholder="Prénoms">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Date de naissance</label>
                        <input type="date" name="conjoint_date_naissance" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Sexe</label>
                        <select name="conjoint_sexe" class="form-select">
                            <option value="">--</option>
                            <option value="M">Masculin</option>
                            <option value="F">Féminin</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Téléphone</label>
                        <input type="text" name="conjoint_telephone" class="form-control" placeholder="6XX XX XX XX">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Profession</label>
                        <input type="text" name="conjoint_profession" class="form-control">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Employeur</label>
                        <input type="text" name="conjoint_employeur" class="form-control">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Date de mariage</label>
                        <input type="date" name="conjoint_date_mariage" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Lieu de mariage</label>
                        <input type="text" name="conjoint_lieu_mariage" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Acte de mariage</label>
                        <input type="file" name="conjoint_acte_mariage" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                </div>

                <hr class="my-4">

                <!-- Enfants -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="bi bi-people"></i> Enfants</h5>
                    <button type="button" class="btn btn-sm btn-success" id="btn-ajouter-enfant">
                        <i class="bi bi-plus-circle"></i> Ajouter un enfant
                    </button>
                </div>
                
                <div id="enfants-container">
                    <!-- Les enfants seront ajoutés dynamiquement ici -->
                </div>
                
                <template id="enfant-template">
                    <div class="enfant-row card mb-3 p-3 bg-light">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong class="enfant-numero">Enfant #1</strong>
                            <button type="button" class="btn btn-sm btn-outline-danger btn-supprimer-enfant">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Nom <span class="text-danger">*</span></label>
                                <input type="text" name="enfant_nom[]" class="form-control" required>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Prénoms <span class="text-danger">*</span></label>
                                <input type="text" name="enfant_prenoms[]" class="form-control" required>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Date naissance <span class="text-danger">*</span></label>
                                <input type="date" name="enfant_date_naissance[]" class="form-control" required>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Sexe</label>
                                <select name="enfant_sexe[]" class="form-select">
                                    <option value="">--</option>
                                    <option value="M">Masculin</option>
                                    <option value="F">Féminin</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Lieu de naissance</label>
                                <input type="text" name="enfant_lieu_naissance[]" class="form-control">
                            </div>
                            <div class="col-md-3 mb-2">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" name="enfant_scolarise[]" value="1">
                                    <label class="form-check-label">Scolarisé</label>
                                </div>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Établissement scolaire</label>
                                <input type="text" name="enfant_etablissement[]" class="form-control">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Acte de naissance</label>
                                <input type="file" name="enfant_acte_naissance[]" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>

<!-- Section Documents Parcours Professionnel -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header text-white" style="background: linear-gradient(135deg, #6f42c1 0%, #8e44ad 100%);">
                <h5 class="mb-0">
                    <i class="bi bi-folder-fill"></i> 
                    Documents de parcours professionnel (optionnel)
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Vous pouvez joindre les documents justificatifs du parcours professionnel de l'employé.
                </div>
                
                <div class="row">
                    <!-- CV -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label"><i class="bi bi-file-person"></i> CV / Curriculum Vitae</label>
                        <input type="file" name="doc_cv" class="form-control" accept=".pdf,.doc,.docx">
                        <small class="text-muted">PDF ou Word</small>
                    </div>
                    
                    <!-- Diplôme principal -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label"><i class="bi bi-mortarboard"></i> Diplôme le plus élevé</label>
                        <input type="file" name="doc_diplome" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                        <small class="text-muted">PDF ou Image</small>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Pièce d'identité -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label"><i class="bi bi-person-badge"></i> Pièce d'identité</label>
                        <input type="file" name="doc_piece_identite" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                        <small class="text-muted">CNI, Passeport, etc.</small>
                    </div>
                    
                    <!-- Certificat médical -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label"><i class="bi bi-heart-pulse"></i> Certificat médical d'aptitude</label>
                        <input type="file" name="doc_certificat_medical" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                </div>
                
                <hr class="my-3">
                <h6 class="mb-3"><i class="bi bi-briefcase"></i> Expériences professionnelles antérieures</h6>
                
                <div class="row">
                    <!-- Attestation de travail -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label"><i class="bi bi-file-earmark-check"></i> Attestation(s) de travail</label>
                        <input type="file" name="doc_attestation_travail[]" class="form-control" accept=".pdf,.jpg,.jpeg,.png" multiple>
                        <small class="text-muted">Plusieurs fichiers possibles</small>
                    </div>
                    
                    <!-- Certificat d'emploi -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label"><i class="bi bi-file-earmark-text"></i> Certificat(s) d'emploi antérieur</label>
                        <input type="file" name="doc_certificat_emploi[]" class="form-control" accept=".pdf,.jpg,.jpeg,.png" multiple>
                        <small class="text-muted">Plusieurs fichiers possibles</small>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Lettre de recommandation -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label"><i class="bi bi-envelope-paper"></i> Lettre(s) de recommandation</label>
                        <input type="file" name="doc_lettre_recommandation[]" class="form-control" accept=".pdf,.jpg,.jpeg,.png" multiple>
                        <small class="text-muted">Plusieurs fichiers possibles</small>
                    </div>
                    
                    <!-- Autres certifications -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label"><i class="bi bi-award"></i> Autres certifications / formations</label>
                        <input type="file" name="doc_certifications[]" class="form-control" accept=".pdf,.jpg,.jpeg,.png" multiple>
                        <small class="text-muted">Plusieurs fichiers possibles</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Retirer la classe d'erreur quand l'utilisateur corrige
    $('input, select').on('change', function() {
        if ($(this).val()) {
            $(this).removeClass('is-invalid');
        }
    });
    
    // Gestion du mode de paiement
    $('#id_mode_paiement').on('change', function() {
        let mode = $(this).val();
        
        // Afficher/masquer les champs selon le mode
        if (mode === 'Virement') {
            $('.field-nom_banque, .field-agence_banque, .field-numero_compte, .field-rib').show();
            $('.field-operateur_mobile_money, .field-numero_mobile_money').hide();
        } else if (mode === 'Mobile Money') {
            $('.field-nom_banque, .field-agence_banque, .field-numero_compte, .field-rib').hide();
            $('.field-operateur_mobile_money, .field-numero_mobile_money').show();
        } else {
            $('.field-nom_banque, .field-agence_banque, .field-numero_compte, .field-rib').hide();
            $('.field-operateur_mobile_money, .field-numero_mobile_money').hide();
        }
    }).trigger('change');
    
    // Calcul automatique de l'âge
    $('#id_date_naissance').on('change', function() {
        let dateNaissance = new Date($(this).val());
        let today = new Date();
        let age = today.getFullYear() - dateNaissance.getFullYear();
        let m = today.getMonth() - dateNaissance.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < dateNaissance.getDate())) {
            age--;
        }
        
        if (age > 0 && age < 120) {
            $(this).after('<small class="form-text text-muted ms-2">Âge: ' + age + ' ans</small>');
        }
    });
    
    // Validation du numéro CNSS (format guinéen)
    $('#id_num_cnss_individuel').on('blur', function() {
        let cnss = $(this).val();
        if (cnss && cnss.length < 10) {
            $(this).addClass('is-invalid');
            $(this).after('<div class="invalid-feedback">Le numéro CNSS doit contenir au moins 10 caractères</div>');
        } else {
            $(this).removeClass('is-invalid');
            $(this).next('.invalid-feedback').remove();
        }
    });
    
    // Preview de la photo
    $('#id_photo').on('change', function(e) {
        let file = e.target.files[0];
        if (file) {
            let reader = new FileReader();
            reader.onload = function(e) {
                $('.photo-preview-container').remove();
                let preview = '<div class="photo-preview-container mt-2"><img src="' + e.target.result + '" class="img-thumbnail"></div>';
                $('#id_photo').closest('.mb-3, .form-group').append(preview);
            };
            reader.readAsDataURL(file);
        }
    });
    
    // ===== CAPTURE PHOTO VIA CAMÉRA =====
    let cameraStream = null;
    
    // Ajouter le bouton caméra après le champ photo
    const cameraHTML = `
        <div class="mt-2">
            <button type="button" id="btn-open-camera" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-camera"></i> Prendre une photo
            </button>
        </div>
        <div id="camera-container">
            <video id="camera-preview" autoplay playsinline></video>
            <canvas id="camera-canvas"></canvas>
            <div class="camera-controls">
                <button type="button" id="btn-capture" class="btn btn-success btn-sm">
                    <i class="bi bi-camera-fill"></i> Capturer
                </button>
                <button type="button" id="btn-close-camera" class="btn btn-secondary btn-sm">
                    <i class="bi bi-x-lg"></i> Fermer
                </button>
            </div>
        </div>
    `;
    $('#id_photo').closest('.mb-3, .form-group').append(cameraHTML);
    
    // Ouvrir la caméra
    $('#btn-open-camera').on('click', async function() {
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } } 
            });
            $('#camera-preview').get(0).srcObject = cameraStream;
            $('#camera-container').slideDown();
            $(this).hide();
        } catch (err) {
            alert('Impossible d\'accéder à la caméra. Vérifiez les permissions.');
            console.error('Erreur caméra:', err);
        }
    });
    
    // Capturer la photo
    $('#btn-capture').on('click', function() {
        const video = $('#camera-preview').get(0);
        const canvas = $('#camera-canvas').get(0);
        const ctx = canvas.getContext('2d');
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        
        // Convertir en fichier
        canvas.toBlob(function(blob) {
            const file = new File([blob], 'photo_employe.jpg', { type: 'image/jpeg' });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            $('#id_photo').get(0).files = dataTransfer.files;
            
            // Afficher preview
            $('.photo-preview-container').remove();
            const preview = `<div class="photo-preview-container mt-2"><img src="${canvas.toDataURL('image/jpeg')}" class="img-thumbnail"></div>`;
            $('#id_photo').closest('.mb-3, .form-group').append(preview);
            
            // Fermer la caméra
            $('#btn-close-camera').click();
        }, 'image/jpeg', 0.9);
    });
    
    // Fermer la caméra
    $('#btn-close-camera').on('click', function() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
        $('#camera-container').slideUp();
        $('#btn-open-camera').show();
    });
    
    // Confirmation avant annulation
    $('button[name="cancel"]').on('click', function(e) {
        if (!confirm('Êtes-vous sûr de vouloir annuler ? Les modifications non enregistrées seront perdues.')) {
            e.preventDefault();
        }
    });
    
    // ===== GESTION DYNAMIQUE DES ENFANTS =====
    let enfantCount = 0;
    
    $('#btn-ajouter-enfant').on('click', function() {
        enfantCount++;
        const template = document.getElementById('enfant-template');
        const clone = template.content.cloneNode(true);
        
        // Mettre à jour le numéro
        clone.querySelector('.enfant-numero').textContent = 'Enfant #' + enfantCount;
        
        // Ajouter au conteneur
        $('#enfants-container').append(clone);
        
        // Mettre à jour le nombre d'enfants dans le formulaire principal si le champ existe
        if ($('#id_nombre_enfants').length) {
            $('#id_nombre_enfants').val(enfantCount);
        }
    });
    
    // Supprimer un enfant
    $(document).on('click', '.btn-supprimer-enfant', function() {
        $(this).closest('.enfant-row').remove();
        enfantCount--;
        
        // Renuméroter les enfants
        $('.enfant-row').each(function(index) {
            $(this).find('.enfant-numero').text('Enfant #' + (index + 1));
        });
        
        // Mettre à jour le nombre d'enfants
        if ($('#id_nombre_enfants').length) {
            $('#id_nombre_enfants').val(enfantCount);
        }
    });
});
</script>
{% endblock %}

