{% extends 'base.html' %}
{% load static %}

{% block title %}Visite Médicale - {{ visite.employe.nom }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <a href="{% url 'employes:liste_visites_medicales' %}" class="btn btn-outline-secondary mb-3">
                <i class="fas fa-arrow-left me-2"></i>Retour
            </a>
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-stethoscope me-2"></i>Visite Médicale</h2>
                <div>
                    {% if visite.aptitude == 'en_attente' %}
                    <a href="{% url 'employes:enregistrer_resultat' visite.pk %}" class="btn btn-success">
                        <i class="fas fa-check me-1"></i>Enregistrer résultat
                    </a>
                    {% endif %}
                    <a href="{% url 'employes:supprimer_visite' visite.pk %}" class="btn btn-danger"
                       onclick="return confirm('Supprimer cette visite ?')">
                        <i class="fas fa-trash me-1"></i>Supprimer
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Informations -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0"><i class="fas fa-user me-2"></i>Informations</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <td class="text-muted">Employé</td>
                                    <td><strong>{{ visite.employe.nom }} {{ visite.employe.prenoms }}</strong></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Matricule</td>
                                    <td>{{ visite.employe.matricule }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Département</td>
                                    <td>{{ visite.employe.service.nom_service|default:"-" }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <td class="text-muted">Type de visite</td>
                                    <td><strong>{{ visite.get_type_visite_display }}</strong></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Date</td>
                                    <td>{{ visite.date_visite|date:"d/m/Y" }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Médecin</td>
                                    <td>{{ visite.medecin|default:"Non spécifié" }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Centre médical</td>
                                    <td>{{ visite.centre_medical|default:"-" }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Résultats -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Résultats</h6>
                </div>
                <div class="card-body">
                    <p><strong>Aptitude:</strong>
                        {% if visite.aptitude == 'apte' %}
                        <span class="badge bg-success fs-6">Apte</span>
                        {% elif visite.aptitude == 'apte_reserves' %}
                        <span class="badge bg-warning fs-6">Apte avec réserves</span>
                        {% elif visite.aptitude == 'inapte_temporaire' %}
                        <span class="badge bg-danger fs-6">Inapte temporaire</span>
                        {% elif visite.aptitude == 'inapte_definitif' %}
                        <span class="badge bg-dark fs-6">Inapte définitif</span>
                        {% elif visite.aptitude == 'en_attente' %}
                        <span class="badge bg-secondary fs-6">En attente de résultat</span>
                        {% endif %}
                    </p>
                    
                    {% if visite.reserves %}
                    <div class="alert alert-warning">
                        <strong><i class="fas fa-exclamation-triangle me-1"></i>Réserves:</strong>
                        <p class="mb-0">{{ visite.reserves }}</p>
                    </div>
                    {% endif %}
                    
                    {% if visite.recommandations %}
                    <p><strong>Recommandations:</strong></p>
                    <p>{{ visite.recommandations }}</p>
                    {% endif %}
                    
                    {% if visite.date_prochaine_visite %}
                    <div class="alert alert-info">
                        <i class="fas fa-calendar me-1"></i>
                        <strong>Prochaine visite prévue:</strong> {{ visite.date_prochaine_visite|date:"d/m/Y" }}
                    </div>
                    {% endif %}
                    
                    {% if visite.fichier_certificat %}
                    <a href="{{ visite.fichier_certificat.url }}" target="_blank" class="btn btn-outline-primary">
                        <i class="fas fa-file-medical me-1"></i>Voir le certificat
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Historique -->
            {% if historique %}
            <div class="card shadow-sm">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-history me-2"></i>Historique des visites</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm mb-0">
                        <thead class="table-secondary">
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Aptitude</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for h in historique %}
                            <tr>
                                <td>{{ h.date_visite|date:"d/m/Y" }}</td>
                                <td>{{ h.get_type_visite_display }}</td>
                                <td>
                                    {% if h.aptitude == 'apte' %}
                                    <span class="badge bg-success">Apte</span>
                                    {% elif h.aptitude == 'apte_reserves' %}
                                    <span class="badge bg-warning">Réserves</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ h.get_aptitude_display }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            <!-- Lien vers suivi employé -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <a href="{% url 'employes:suivi_medical_employe' visite.employe.pk %}" class="btn btn-outline-info w-100">
                        <i class="fas fa-notes-medical me-1"></i>Suivi médical complet
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
